<%- include('../layouts/header', { pageStyles: '/css/dashboard.css' }) %>

  <style>
    .tweet-card {
      background-color: #253341 !important;
      border: 1px solid #38444d !important;
      border-radius: 12px !important;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
    }

    .tweet-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4) !important;
      border-color: #1da1f2 !important;
      background-color: #2a3a4a !important;
    }

    .tweet-content p {
      font-size: 16px;
      line-height: 1.5;
      color: #ecf0f1;
    }

    .tweet-meta {
      border-top: 1px solid #38444d;
      padding-top: 8px;
      margin-top: 8px;
    }

    .tweet-meta small {
      font-size: 12px;
      color: #bdc3c7 !important;
    }

    .tweet-meta i {
      color: #1da1f2;
    }

    .bg-light {
      background-color: #253341 !important;
    }

    .twitter-card {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      border: 1px solid #34495e;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .twitter-card h3,
    .twitter-card h4 {
      color: #ecf0f1 !important;
    }

    .twitter-card p {
      color: #bdc3c7 !important;
    }

    .twitter-card .text-muted {
      color: #95a5a6 !important;
    }

    body {
      background-color: #2c3e50;
    }

    /* æœç´¢æ¡†æ ·å¼ */
    .search-container {
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* æœç´¢æ æ ·å¼ä¼˜åŒ– - å»é™¤å›¾æ ‡ï¼Œå¢åŠ é—´è· */
    .search-box {
      max-width: 600px;
      margin: 0 auto;
    }

    .search-box .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-box .form-control {
      background-color: #253341 !important;
      border-color: #38444d !important;
      color: #ffffff !important;
      border-radius: 25px 0 0 25px !important;
      padding: 12px 20px;
      font-size: 16px;
      flex: 1;
    }

    .search-box .form-control:focus {
      background-color: #253341 !important;
      border-color: #1da1f2 !important;
      color: #ffffff !important;
      box-shadow: 0 0 0 0.2rem rgba(29, 161, 242, 0.25) !important;
    }

    .search-box .btn-twitter {
      background-color: #1da1f2 !important;
      border-color: #1da1f2 !important;
      color: #ffffff !important;
      border-radius: 0 25px 25px 0 !important;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 16px;
      white-space: nowrap;
    }

    .search-box .btn-twitter:hover {
      background-color: #0d8bd9 !important;
      border-color: #0d8bd9 !important;
    }

    /* æœç´¢å…³é”®è¯é«˜äº®æ ·å¼ */
    .search-highlight {
      background-color: #1da1f2 !important;
      color: #ffffff !important;
      padding: 2px 6px !important;
      border-radius: 12px !important;
      font-weight: 600 !important;
      box-shadow: 0 2px 4px rgba(29, 161, 242, 0.3) !important;
      transition: all 0.2s ease !important;
    }

    .search-highlight:hover {
      background-color: #0d8bd9 !important;
      transform: scale(1.05) !important;
    }

    /* ç¤¾ç¾¤é€‰æ‹©å™¨æ ·å¼ */
    .form-select {
      background-color: #253341 !important;
      border-color: #38444d !important;
      color: #ffffff !important;
      border-radius: 8px !important;
      transition: all 0.3s ease !important;
    }

    .form-select:focus {
      background-color: #253341 !important;
      border-color: #1da1f2 !important;
      color: #ffffff !important;
      box-shadow: 0 0 0 0.2rem rgba(29, 161, 242, 0.25) !important;
    }

    .form-select option {
      background-color: #253341 !important;
      color: #ffffff !important;
    }

    .form-label {
      font-weight: 600 !important;
      margin-bottom: 8px !important;
    }

    .form-text {
      font-size: 0.875rem !important;
      margin-top: 4px !important;
    }

    /* åŠ è½½æŒ‰é’®æ–‡å­—é¢œè‰² */
    #load-more-text {
      color: #ffffff !important;
    }

    .btn-outline-twitter {
      color: #1da1f2 !important;
      border-color: #1da1f2 !important;
    }

    .btn-outline-twitter:hover {
      color: #ffffff !important;
      background-color: #1da1f2 !important;
    }

    .btn-outline-twitter:disabled {
      color: #ffffff !important;
      background-color: #1da1f2 !important;
      opacity: 0.7 !important;
    }
  </style>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <%- include('../layouts/sidebar', { user: user }) %>
        <!-- Main -->
        <div class="col-md-9 offset-md-3">
          <!-- å›ºå®šæœç´¢æ¡† -->
          <div class="search-container fixed-top"
            style="top: 0; left: 25%; right: 0; z-index: 1000; background-color: #15202b; padding: 15px; border-bottom: 1px solid #38444d;">
            <div class="search-box">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Search tweets, users, or topics..."
                  id="search-input">
                <button class="btn btn-twitter" type="button" id="search-btn">
                  <i class="fas fa-search me-1"></i>Search
                </button>
              </div>
            </div>
          </div>

          <!-- å†…å®¹åŒºåŸŸï¼Œæ·»åŠ é¡¶éƒ¨é—´è·é¿å…è¢«æœç´¢æ¡†é®æŒ¡ -->
          <div class="p-4" style="margin-top: 80px;">
            <!-- Welcome -->
            <div class="twitter-card p-4 mb-4">
              <h3 class="text-twitter mb-3">
                <i class="fas fa-home me-2"></i>Welcome to Twikk, <%= user.name %>!
              </h3>
              <p class="text-muted">This is your dashboard. Post tweets, view the timeline, and manage your account.</p>
            </div>

            <!-- Profile -->
            <div class="twitter-card p-4 mb-4">
              <h4 class="text-twitter mb-3">
                <i class="fas fa-user-circle me-2"></i>Profile
              </h4>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Name:</strong>
                    <%= user.name %>
                  </p>
                  <p><strong>Username:</strong> @<%= user.username %>
                  </p>
                </div>
                <div class="col-md-6">
                  <p><strong>Email:</strong>
                    <%= user.email %>
                  </p>
                  <p><strong>User ID:</strong>
                    <%= user.id %>
                  </p>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-12">
                  <p><strong>Wallet:</strong>
                    <% if (user.walletAddress) { %>
                      <span class="text-success">Linked: <%= user.walletAddress %></span>
                      <button id="unlink-wallet-btn" class="btn btn-sm btn-outline-danger ms-2">Unlink Wallet</button>
                    <% } else { %>
                      <span class="text-muted">Not linked</span>
                      <button id="metamask-login-btn" class="btn btn-sm btn-outline-primary ms-2">Link Wallet</button>
                    <% } %>
                  </p>
                </div>
              </div>
            </div>

            <!-- Compose -->
            <div class="twitter-card p-4 mb-4">
              <h4 class="text-twitter mb-3">
                <i class="fas fa-feather-alt me-2"></i>Compose new Tweet
              </h4>
              <form action="/tweet" method="POST">
                <div class="mb-3">
                  <textarea class="form-control" name="content" rows="3" maxlength="280"
                    placeholder="What's happening?"></textarea>
                </div>
                
                <!-- ç¤¾ç¾¤é€‰æ‹© -->
                <div class="mb-3">
                  <label for="category" class="form-label text-light">
                    <i class="fas fa-users me-2"></i>Choose Community (Optional)
                  </label>
                  <select class="form-select" name="category" id="category">
                    <option value="">General (No specific community)</option>
                    <option value="sports">ğŸˆ Sports</option>
                    <option value="politics">ğŸ›ï¸ Politics</option>
                    <option value="entertainment">ğŸ¬ Entertainment</option>
                  </select>
                  <div class="form-text text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Select a community to categorize your tweet and reach the right audience
                  </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">Up to 280 characters</span>
                  <button type="submit" class="btn btn-twitter">
                    <i class="fas fa-paper-plane me-2"></i>Tweet
                  </button>
                </div>
              </form>
            </div>

            <!-- Timeline -->
            <div class="twitter-card p-4">
              <h4 class="text-twitter mb-3">
                <i class="fas fa-stream me-2"></i>Timeline
              </h4>
              <section class="timeline">
                <ul class="timeline-list" id="tweets-container">
                  <% if (tweets && tweets.length> 0) { %>
                    <% tweets.forEach(t=> { %>
                      <li class="timeline-item">
                        <div class="tweet-card mb-3 p-3 bg-light border rounded shadow-sm" data-tweet-id="<%= t._id %>">
                          <div class="tweet-header mb-2">
                            <i class="fas fa-user-circle text-twitter me-2"></i>
                            <strong class="text-white">
                              <%= t.authorName %>
                            </strong>
                            <span class="text-muted ms-2">@<%= t.authorName.toLowerCase().replace(/\s+/g, '' ) %></span>
                          </div>
                          <div class="tweet-content">
                            <p class="text-light mb-0"><%= t.content %></p>
                          </div>
                          <div class="tweet-meta d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                              <i class="fas fa-clock me-1"></i>
                              <%= new Date(t.createdAt).toLocaleString() %>
                            </small>
                            <div>
                              <button class="btn btn-sm btn-like <%= t.isLikedByCurrentUser ? 'liked' : '' %>"
                                data-tweet-id="<%= t._id %>">
                                <i class="fas fa-heart"></i>
                                <span class="likes-count"><%= t.likesCount || 0 %></span>
                              </button>
                            </div>
                          </div>

                          <div class="comments-section mt-3">
                            <div class="comments-list">
                              <% if (t.comments && t.comments.length> 0) { %>
                                <% t.comments.slice(-3).forEach(c=> { %>
                                  <div class="comment mb-2">
                                    <strong class="text-white"><%= c.authorName %></strong>
                                    <span class="text-muted ms-2"><%= new Date(c.createdAt).toLocaleString() %></span>
                                    <p class="text-light mb-1"><%= c.content %></p>
                                  </div>
                                <% }) %>
                              <% } %>
                            </div>

                            <form class="comment-form d-flex mt-2" data-tweet-id="<%= t._id %>">
                              <input type="text" name="content" class="form-control form-control-sm me-2"
                                placeholder="Write a comment..." required maxlength="1000">
                              <button type="submit" class="btn btn-sm btn-twitter">Reply</button>
                            </form>
                          </div>
                        </div>
                      </li>
                    <% }) %>
                  <% } else { %>
                    <li class="text-center text-muted py-5">
                      <i class="fas fa-comments fa-3x mb-3"></i>
                      <p>No tweets yet</p>
                      <p>Start by posting your first one!</p>
                    </li>
                  <% } %>
                </ul>
              </section>

              <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
              <div id="load-more-container" class="text-center mt-4" style="display: none;">
                <button id="load-more-btn" class="btn btn-outline-twitter">
                  <i class="fas fa-spinner fa-spin me-2" id="loading-spinner" style="display: none;"></i>
                  <span id="load-more-text">Load More Tweets</span>
                </button>
              </div>


              <!-- æ²¡æœ‰æ›´å¤šæ¨æ–‡æç¤º -->
              <div id="no-more-tweets" class="text-center text-muted mt-4" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>
                No more tweets
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>

  <script>
    function showUserInfo() {
      alert('User info:\nName: <%= user.name %>\nUsername: @<%= user.username %>\nEmail: <%= user.email %>');
    }

    // æ— é™æ»šåŠ¨åŠŸèƒ½
    let currentPage = 1;
    let isLoading = false;
    let hasMoreTweets = true;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      // å¦‚æœæœ‰æ¨æ–‡ï¼Œæ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
      if (document.querySelectorAll('.tweet-card').length > 0) {
        document.getElementById('load-more-container').style.display = 'block';
      }

      // å»¶è¿Ÿæ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œç¡®ä¿é¡µé¢å®Œå…¨æ¸²æŸ“
      setTimeout(() => {
        window.scrollTo(0, 0);
      }, 500);

      // æ·»åŠ æ»šåŠ¨ç›‘å¬å™¨å®ç°æ— é™æ»šåŠ¨
      window.addEventListener('scroll', handleScroll);
    });

    // æ»šåŠ¨å¤„ç†å‡½æ•°
    function handleScroll() {
      // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨é™„è¿‘
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      // å½“æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨200pxæ—¶è‡ªåŠ¨åŠ è½½æ›´å¤š
      if (scrollTop + windowHeight >= documentHeight - 200) {
        if (hasMoreTweets && !isLoading) {
          loadMoreTweets();
        }
      }
    }

    // åŠ è½½æ›´å¤šæ¨æ–‡
    async function loadMoreTweets() {
      if (isLoading || !hasMoreTweets) return;

      isLoading = true;
      const loadMoreBtn = document.getElementById('load-more-btn');
      const loadingSpinner = document.getElementById('loading-spinner');
      const loadMoreText = document.getElementById('load-more-text');

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loadingSpinner.style.display = 'inline-block';
      loadMoreText.textContent = 'Loading...';
      if (loadMoreBtn) loadMoreBtn.disabled = true;

      try {
        // æ·»åŠ 0.1ç§’å»¶è¿Ÿï¼Œè®©åˆ†é¡µæ•ˆæœæ›´æ˜æ˜¾
        await new Promise(resolve => setTimeout(resolve, 800));

        const response = await fetch(`/api/tweets?page=${currentPage + 1}&limit=20`);
        const data = await response.json();

        if (data.tweets && data.tweets.length > 0) {
          // æ·»åŠ æ–°æ¨æ–‡åˆ°é¡µé¢
          const tweetsContainer = document.getElementById('tweets-container');
          data.tweets.forEach(tweet => {
            const li = document.createElement('li');
            li.className = 'timeline-item';
            li.innerHTML = `
              <div class="tweet-card mb-3 p-3 bg-light border rounded shadow-sm" data-tweet-id="${tweet._id}">
                <div class="tweet-header mb-2">
                  <i class="fas fa-user-circle text-twitter me-2"></i>
                  <strong class="text-white">${tweet.authorName}</strong>
                  <span class="text-muted ms-2">@${tweet.authorName.toLowerCase().replace(/\s+/g, '')}</span>
                </div>
                <div class="tweet-content">
                  <p class="text-light mb-0">${tweet.content}</p>
                </div>
                <div class="tweet-meta d-flex justify-content-between align-items-center mt-2">
                  <small class="text-muted"><i class="fas fa-clock me-1"></i>${new Date(tweet.createdAt).toLocaleString()}</small>
                  <div>
                    <button class="btn btn-sm btn-like ${tweet.isLikedByCurrentUser ? 'liked' : ''}" data-tweet-id="${tweet._id}">
                      <i class="fas fa-heart"></i>
                      <span class="likes-count">${tweet.likesCount || 0}</span>
                    </button>
                  </div>
                </div>
                <div class="comments-section mt-3">
                  <div class="comments-list">
                    ${tweet.comments && tweet.comments.length > 0 ? tweet.comments.slice(-3).map(comment => `
                      <div class="comment mb-2">
                        <strong class="text-white">${comment.authorName}</strong>
                        <span class="text-muted ms-2">${new Date(comment.createdAt).toLocaleString()}</span>
                        <p class="text-light mb-1">${comment.content}</p>
                      </div>
                    `).join('') : ''}
                  </div>
                  <form class="comment-form d-flex mt-2" data-tweet-id="${tweet._id}">
                    <input type="text" name="content" class="form-control form-control-sm me-2" placeholder="Write a comment..." required maxlength="1000">
                    <button type="submit" class="btn btn-sm btn-twitter">Reply</button>
                  </form>
                </div>
              </div>
            `;
            tweetsContainer.appendChild(li);
          });

          currentPage++;
          hasMoreTweets = data.hasMore;

          if (!hasMoreTweets) {
            document.getElementById('load-more-container').style.display = 'none';
            document.getElementById('no-more-tweets').style.display = 'block';
          }
        } else {
          hasMoreTweets = false;
          document.getElementById('load-more-container').style.display = 'none';
          document.getElementById('no-more-tweets').style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to load tweets:', error);
        loadMoreText.textContent = 'Load failed, click to retry';
      } finally {
        // éšè—åŠ è½½çŠ¶æ€
        loadingSpinner.style.display = 'none';
        loadMoreText.textContent = 'Load More Tweets';
        if (loadMoreBtn) loadMoreBtn.disabled = false;
        isLoading = false;
      }
    }

    // ç»‘å®šåŠ è½½æ›´å¤šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('load-more-btn').addEventListener('click', loadMoreTweets);


    // æœç´¢åŠŸèƒ½
    async function performSearch() {
      const searchTerm = document.getElementById('search-input').value.trim();
      if (!searchTerm) {
        alert('Please enter a search keyword');
        return;
      }

      try {
        // æ˜¾ç¤ºæœç´¢çŠ¶æ€
        const searchBtn = document.getElementById('search-btn');
        const originalText = searchBtn.innerHTML;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Searching...';
        searchBtn.disabled = true;

        // å‘é€æœç´¢è¯·æ±‚
        const response = await fetch(`/api/search?q=${encodeURIComponent(searchTerm)}`);
        const data = await response.json();

        if (data.error) {
          alert('Search failed: ' + data.error);
          return;
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        displaySearchResults(data.tweets, data.query);

      } catch (error) {
        console.error('Search error:', error);
        alert('Search failed. Please try again.');
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const searchBtn = document.getElementById('search-btn');
        searchBtn.innerHTML = '<i class="fas fa-search me-1"></i>Search';
        searchBtn.disabled = false;
      }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displaySearchResults(tweets, query) {
      const tweetsContainer = document.getElementById('tweets-container');
      const loadMoreContainer = document.getElementById('load-more-container');
      const noMoreTweets = document.getElementById('no-more-tweets');

      // éšè—Welcomeã€Profileå’ŒComposeéƒ¨åˆ†
      const welcomeSection = document.querySelector('.twitter-card:first-of-type');
      const profileSection = document.querySelector('.twitter-card:nth-of-type(2)');
      const composeSection = document.querySelector('.twitter-card:nth-of-type(3)');

      if (welcomeSection) welcomeSection.style.display = 'none';
      if (profileSection) profileSection.style.display = 'none';
      if (composeSection) composeSection.style.display = 'none';

      // éšè—åŠ è½½æ›´å¤šæŒ‰é’®
      loadMoreContainer.style.display = 'none';
      noMoreTweets.style.display = 'none';

      if (tweets.length === 0) {
        tweetsContainer.innerHTML = `
        <li class="text-center py-5" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border: 1px solid #38444d; border-radius: 12px;">
          <i class="fas fa-search fa-3x mb-3 text-light"></i>
          <p class="text-light">No tweets found for "${query}"</p>
          <p class="text-muted">Try different keywords</p>
        </li>
      `;
      } else {
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        tweetsContainer.innerHTML = `
        <div class="mb-3 p-3 rounded" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border: 1px solid #38444d;">
          <h5 class="text-white"><i class="fas fa-search me-2"></i>Search Results for "${query}"</h5>
          <p class="mb-0 text-light">Found ${tweets.length} tweet(s)</p>
        </div>
      `;

        tweets.forEach(tweet => {
          const li = document.createElement('li');
          li.className = 'timeline-item';
          li.innerHTML = `
            <div class="tweet-card mb-3 p-3 bg-light border rounded shadow-sm" data-tweet-id="${tweet._id}">
              <div class="tweet-header mb-2">
                <i class="fas fa-user-circle text-twitter me-2"></i>
                <strong class="text-white">${tweet.authorName}</strong>
                <span class="text-muted ms-2">@${tweet.authorName.toLowerCase().replace(/\s+/g, '')}</span>
              </div>
              <div class="tweet-content">
                <p class="text-light mb-0">${highlightSearchTerm(tweet.content, query)}</p>
              </div>
              <div class="tweet-meta d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted"><i class="fas fa-clock me-1"></i>${new Date(tweet.createdAt).toLocaleString()}</small>
                <div>
                  <button class="btn btn-sm btn-like ${tweet.isLikedByCurrentUser ? 'liked' : ''}" data-tweet-id="${tweet._id}">
                    <i class="fas fa-heart"></i>
                    <span class="likes-count">${tweet.likesCount || 0}</span>
                  </button>
                </div>
              </div>
              <div class="comments-section mt-3">
                <div class="comments-list">
                  ${tweet.comments && tweet.comments.length > 0 ? tweet.comments.slice(-3).map(comment => `
                    <div class="comment mb-2">
                      <strong class="text-white">${comment.authorName}</strong>
                      <span class="text-muted ms-2">${new Date(comment.createdAt).toLocaleString()}</span>
                      <p class="text-light mb-1">${comment.content}</p>
                    </div>
                  `).join('') : ''}
                </div>
                <form class="comment-form d-flex mt-2" data-tweet-id="${tweet._id}">
                  <input type="text" name="content" class="form-control form-control-sm me-2" placeholder="Write a comment..." required maxlength="1000">
                  <button type="submit" class="btn btn-sm btn-twitter">Reply</button>
                </form>
              </div>
            </div>
          `;
          tweetsContainer.appendChild(li);
        });

        // æ·»åŠ è¿”å›æŒ‰é’®
        const returnLi = document.createElement('li');
        returnLi.className = 'text-center mt-4';
        returnLi.innerHTML = `
        <button class="btn btn-outline-twitter" onclick="returnToTimeline()">
          <i class="fas fa-arrow-left me-2"></i>Back to Timeline
        </button>
      `;
        tweetsContainer.appendChild(returnLi);
      }
    }

    // é«˜äº®æœç´¢å…³é”®è¯
    function highlightSearchTerm(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark class="search-highlight">$1</mark>');
    }

    // è¿”å›æ—¶é—´çº¿
    function returnToTimeline() {
      // é‡æ–°åŠ è½½æ—¶é—´çº¿
      location.reload();
    }

    // ç»‘å®šæœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('search-btn').addEventListener('click', performSearch);

    // ç»‘å®šå›è½¦é”®æœç´¢
    document.getElementById('search-input').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // ç‚¹èµæŒ‰é’®å¤„ç†ï¼ˆäº‹ä»¶ä»£ç†ï¼‰
    document.addEventListener('click', async function (e) {
      const likeBtn = e.target.closest('.btn-like');
      if (!likeBtn) return;

      const tweetId = likeBtn.getAttribute('data-tweet-id');
      if (!tweetId) return;

      try {
        likeBtn.disabled = true;
        const resp = await fetch(`/like/${tweetId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await resp.json();
        if (data && data.ok) {
          const likesCountSpan = likeBtn.querySelector('.likes-count');
          likesCountSpan.textContent = data.likesCount;
          if (data.action === 'liked') {
            likeBtn.classList.add('liked');
          } else {
            likeBtn.classList.remove('liked');
          }
        } else if (data && data.error) {
          alert('Error: ' + data.error);
        }
      } catch (err) {
        console.error('Like action failed', err);
        alert('Like failed.');
      } finally {
        likeBtn.disabled = false;
      }
    });

    // è¯„è®ºè¡¨å•æäº¤ï¼ˆäº‹ä»¶ä»£ç†ï¼‰
    document.addEventListener('submit', async function (e) {
      const form = e.target.closest('.comment-form');
      if (!form) return;
      e.preventDefault();

      const tweetId = form.getAttribute('data-tweet-id');
      const input = form.querySelector('input[name="content"]');
      if (!input) return;
      const content = input.value.trim();
      if (!content) return;

      try {
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        const resp = await fetch(`/comment/${tweetId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });

        const data = await resp.json();
        if (data && data.ok && data.comment) {
          const commentsList = form.parentElement.querySelector('.comments-list');
          const div = document.createElement('div');
          div.className = 'comment mb-2';
          div.innerHTML = `<strong class="text-white">${data.comment.authorName}</strong> <span class="text-muted ms-2">${new Date(data.comment.createdAt).toLocaleString()}</span><p class="text-light mb-1">${data.comment.content}</p>`;
          commentsList.appendChild(div);
          input.value = '';
        } else if (data && data.error) {
          alert('Error: ' + data.error);
        }
      } catch (err) {
        console.error('Comment failed', err);
        alert('Comment failed.');
      } finally {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = false;
      }
    });

  </script>

  <%- include('../layouts/footer') %>

  <!-- MetaMask client script (ensure Link/Unlink buttons work on dashboard) -->
  <script src="/js/metamask.js"></script>